@model IEnumerable<BTL_QlBi_a.Models.Entities.BanBia>
@{
    Layout = "~/Views/Shared/_LayoutUser.cshtml"; // Trỏ vào layout mới tạo
    ViewData["Title"] = "Trang chủ";
}

<div style="background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1571216821602-74eb236332d3?q=80&w=1920'); background-size: cover; padding: 100px 0; border-bottom: 4px solid #00f2fe; margin-bottom: 40px;">
    <div class="container text-center">
        <h1 class="display-4 fw-bold text-white mb-3">ĐẲNG CẤP BI-A CHUYÊN NGHIỆP</h1>
        <p class="lead text-light mb-4">Không gian sang trọng - Bàn chuẩn thi đấu</p>
        <a href="#member" class="btn btn-lg btn-info fw-bold" style="background: #00f2fe; border: none; color: #000;">TRA CỨU HẠNG NGAY</a>
    </div>
</div>

<div class="container mb-5" id="tables">
    <div class="text-center mb-4">
        <h2 class="text-white section-heading">TRẢI NGHIỆM ĐẲNG CẤP</h2>
        <p class="text-muted">Chọn loại bàn yêu thích của bạn</p>
    </div>

    @{
        // Lấy danh sách các loại bàn duy nhất có trong DB
        var listLoaiBan = Model.Select(b => b.LoaiBan).Where(l => l != null).DistinctBy(l => l.MaLoai).ToList();
    }

    <ul class="nav nav-pills justify-content-center mb-5" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active rounded-pill px-4" id="pills-all-tab" data-bs-toggle="pill" data-bs-target="#pills-all" type="button" role="tab">
                Tất cả
            </button>
        </li>

        @foreach (var loai in listLoaiBan)
        {
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-pill px-4" id="pills-@loai.MaLoai-tab" data-bs-toggle="pill" data-bs-target="#pills-@loai.MaLoai" type="button" role="tab">
                    @loai.TenLoai
                </button>
            </li>
        }
    </ul>

    <div class="tab-content" id="pills-tabContent">

        <div class="tab-pane fade show active" id="pills-all" role="tabpanel">
            <div class="row g-4">
                @foreach (var ban in Model)
                {
                    RenderTableCard(ban);
                 }
            </div>
        </div>

        @foreach (var loai in listLoaiBan)
        {
                <div class="tab-pane fade" id="pills-@loai.MaLoai" role="tabpanel">
                    <div class="row g-4">
                    @foreach (var ban in Model.Where(b => b.MaLoai == loai.MaLoai))
                    {
                        RenderTableCard(ban);                  
                    }
                    </div>
                </div>
        }
    </div>
</div>

@{
    void RenderTableCard(BTL_QlBi_a.Models.Entities.BanBia ban)
    {
        bool isTrong = ban.TrangThai == BTL_QlBi_a.Models.Entities.TrangThaiBan.Trong;
        string statusColor = isTrong ? "#28a745" : "#dc3545";
        string statusText = isTrong ? "Sẵn sàng" : "Đang chơi";
        string glowClass = isTrong ? "glow-border" : "";

        // Ảnh mặc định nếu chưa có ảnh
        string imgSrc = string.IsNullOrEmpty(ban.HinhAnh)
            ? "https://images.unsplash.com/photo-1534158914592-062992fbe900?w=600&q=80" // Ảnh bi-a mẫu
            : ban.HinhAnh; 

                <div class="col-12 col-md-6 col-lg-3">
                    <div class="card h-100 table-card @glowClass">
                        <div class="card-img-wrapper">
                            <img src="@imgSrc" class="card-img-top" alt="@ban.TenBan">
                            <div class="price-badge">
                        @(ban.LoaiBan?.GiaGio.ToString("N0"))đ/h
                            </div>
                            <div class="status-badge" style="background-color: @statusColor">
                        @if (isTrong)
                        {
                            <i class="fa-solid fa-check me-1"></i>
                        }
                        else
                        {
                            <i class="fa-solid fa-user-clock me-1"></i>
                        }
                        @statusText
                            </div>
                        </div>

                        <div class="card-body text-center">
                            <h5 class="card-title text-white fw-bold">@ban.TenBan</h5>
                            <p class="card-text text-muted small">
                                <i class="fa-solid fa-layer-group me-1"></i> @(ban.LoaiBan?.TenLoai ?? "Bàn tiêu chuẩn") <br/>
                                <i class="fa-solid fa-location-dot me-1"></i> @(ban.KhuVuc?.TenKhuVuc ?? "Sảnh chính")
                            </p>

                    @if (isTrong)
                    {
                        if (Context.Session.GetInt32("MaKH") != null)
                        {
                                            <button class="btn btn-info w-100 fw-bold" onclick="bookTable(@ban.MaBan)">ĐẶT BÀN NGAY</button>
                        }
                        else
                        {
                                            <a href="/Account/Login" class="btn btn-outline-light w-100 btn-sm">Đăng nhập để đặt</a>
                        }
                    }
                    else
                    {
                                    <button class="btn btn-secondary w-100" disabled>Vui lòng chờ</button>
                    }
                        </div>
                    </div>
                </div>
    }
}

<div class="container py-5" id="member">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="p-4" style="background: #16213e; border-radius: 15px; border: 1px solid #2a2a4e; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                <h3 class="text-center mb-4 text-white">👑 KIỂM TRA HẠNG THÀNH VIÊN</h3>

                <div class="input-group mb-3">
                    <input type="text" id="sdtInput" class="form-control form-control-lg" placeholder="Nhập số điện thoại...">
                    <button class="btn btn-info" onclick="lookupMember()" style="background: #00f2fe; color: #000; font-weight: bold;">Kiểm tra</button>
                </div>

                <div id="memberResult" class="text-center mt-4" style="display: none;">
                    <div style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid #00f2fe; overflow: hidden; margin: 0 auto 15px auto;">
                        <img id="resAvatar" src="" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <h4 id="resName" class="text-white fw-bold"></h4>
                    <div id="resRank" class="mb-3"></div>

                    <div class="row text-white border-top border-secondary pt-3">
                        <div class="col-6 border-end border-secondary">
                            <small class="d-block text-muted">Điểm tích lũy</small>
                            <span class="fw-bold fs-4 text-warning" id="resPoint"></span>
                        </div>
                        <div class="col-6">
                            <small class="d-block text-muted">Tổng chi tiêu</small>
                            <span class="fw-bold fs-4 text-info" id="resSpend"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
        <script>
            async function lookupMember() {
                const sdt = document.getElementById('sdtInput').value;
                if (!sdt) { alert('Vui lòng nhập SĐT!'); return; }

                // URL gọi về Controller Users, Action TraCuuThanhVien
                const url = '/Users/TraCuuThanhVien?sdt=' + sdt;

                try {
                    const response = await fetch(url);
                    const result = await response.json();

                    if (result.success) {
                        const data = result.data;
                        document.getElementById('resName').innerText = data.ten;
                        document.getElementById('resRank').innerHTML = `<span class="badge bg-warning text-dark">${data.hang}</span>`;
                        document.getElementById('resPoint').innerText = data.diem;
                        document.getElementById('resSpend').innerText = data.chiTieu;
                        document.getElementById('resAvatar').src = data.avatar;

                        // Hiệu ứng hiện ra
                        document.getElementById('memberResult').style.display = 'block';
                    } else {
                        alert(result.message);
                        document.getElementById('memberResult').style.display = 'none';
                    }
                } catch (error) {
                    console.error(error);
                    alert('Lỗi kết nối!');
                }
            }
        </script>
}