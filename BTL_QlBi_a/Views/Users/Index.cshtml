@model IEnumerable<BTL_QlBi_a.Models.Entities.BanBia>
@{
    Layout = "~/Views/Shared/_LayoutUser.cshtml";
    ViewData["Title"] = "Trang chủ";
}

<div style="background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1571216821602-74eb236332d3?q=80&w=1920'); background-size: cover; padding: 100px 0; border-bottom: 4px solid #00f2fe; margin-bottom: 40px;">
    <div class="container text-center">
        <h1 class="display-4 fw-bold text-white mb-3">ĐẲNG CẤP BI-A CHUYÊN NGHIỆP</h1>
        <p class="lead text-light mb-4">Không gian sang trọng - Bàn chuẩn thi đấu</p>
        <a href="#member" class="btn btn-lg btn-info fw-bold" style="background: #00f2fe; border: none; color: #000;">TRA CỨU HẠNG NGAY</a>
    </div>
</div>

<div class="container mb-5" id="tables">
    <div class="text-center mb-4">
        <h2 class="text-white section-heading">TRẢI NGHIỆM ĐẲNG CẤP</h2>
        <p class="text-muted">Chọn loại bàn yêu thích của bạn</p>
    </div>

    @{
        // Lấy danh sách các loại bàn duy nhất có trong DB
        var listLoaiBan = Model.Select(b => b.LoaiBan).Where(l => l != null).DistinctBy(l => l.MaLoai).ToList();
    }

    <ul class="nav nav-pills justify-content-center mb-5" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active rounded-pill px-4" id="pills-all-tab" data-bs-toggle="pill" data-bs-target="#pills-all" type="button" role="tab">
                Tất cả
            </button>
        </li>

        @foreach (var loai in listLoaiBan)
        {
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-pill px-4" id="pills-@loai.MaLoai-tab" data-bs-toggle="pill" data-bs-target="#pills-@loai.MaLoai" type="button" role="tab">
                    @loai.TenLoai
                </button>
            </li>
        }
    </ul>

    <div class="tab-content" id="pills-tabContent">

        <div class="tab-pane fade show active" id="pills-all" role="tabpanel">
            <div class="row g-4">
                @foreach (var ban in Model)
                {
                    RenderTableCard(ban);
                 }
            </div>
        </div>

        @foreach (var loai in listLoaiBan)
        {
                <div class="tab-pane fade" id="pills-@loai.MaLoai" role="tabpanel">
                    <div class="row g-4">
                    @foreach (var ban in Model.Where(b => b.MaLoai == loai.MaLoai))
                    {
                        RenderTableCard(ban);                  
                    }
                    </div>
                </div>
        }
    </div>
</div>

@{
    void RenderTableCard(BTL_QlBi_a.Models.Entities.BanBia ban)
    {
        bool isTrong = ban.TrangThai == BTL_QlBi_a.Models.Entities.TrangThaiBan.Trong;
        string statusColor = isTrong ? "#28a745" : "#dc3545";
        string statusText = isTrong ? "Sẵn sàng" : "Đang chơi";
        string glowClass = isTrong ? "glow-border" : "";

        // --- CẬP NHẬT LOGIC ẢNH TẠI ĐÂY ---
        string imgSrc;

        if (!string.IsNullOrEmpty(ban.HinhAnh))
        {
            // Dùng Url.Content như bạn muốn để trỏ đúng vào thư mục asset
            imgSrc = Url.Content($"~/asset/img/{ban.HinhAnh}");
        }
        else
        {
            // Ảnh mặc định (Online hoặc Local) nếu bàn chưa có hình
            imgSrc = "https://images.unsplash.com/photo-1534158914592-062992fbe900?w=600&q=80";
        }
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="card h-100 table-card @glowClass">
                        <div class="card-img-wrapper">
                            <img src="@imgSrc" class="card-img-top" alt="@ban.TenBan">

                            <div class="price-badge">
                        @(ban.LoaiBan?.GiaGio.ToString("N0"))đ/h
                            </div>
                            <div class="status-badge" style="background-color: @statusColor">
                        @if (isTrong)
                        {
                            <i class="fa-solid fa-check me-1"></i>
                        }
                        else
                        {
                            <i class="fa-solid fa-user-clock me-1"></i>
                        }
                        @statusText
                            </div>
                        </div>

                        <div class="card-body text-center">
                                    @if (Context.Session.GetInt32("MaKH") != null)
                                    {
                                    <button class="btn btn-info w-100 fw-bold" 
                                            onclick="bookTable(@ban.MaBan, '@ban.TenBan')">
                                        ĐẶT BÀN (Chọn giờ)
                                    </button>
                                    }
                                    else
                                    {
                                    <a href="/Account/Login" class="btn btn-outline-light w-100 btn-sm">Đăng nhập để đặt</a>
                                    }

                                    @if (!isTrong)
                                    {
                                    <div class="mt-2 text-danger small">
                                        <i class="fa-solid fa-circle-info"></i> Bàn đang có khách chơi
                                    </div>
                                    }
                        </div>
                    </div>
                </div>
    }
}

<div class="container py-5" id="member">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="p-4" style="background: #16213e; border-radius: 15px; border: 1px solid #2a2a4e; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                <h3 class="text-center mb-4 text-white">👑 KIỂM TRA HẠNG THÀNH VIÊN</h3>

                <div class="input-group mb-3">
                    <input type="text" id="sdtInput" class="form-control form-control-lg" placeholder="Nhập số điện thoại...">
                    <button class="btn btn-info" onclick="lookupMember()" style="background: #00f2fe; color: #000; font-weight: bold;">Kiểm tra</button>
                </div>

                <div id="memberResult" class="text-center mt-4" style="display: none;">
                    <div style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid #00f2fe; overflow: hidden; margin: 0 auto 15px auto;">
                        <img id="resAvatar" src="" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <h4 id="resName" class="text-white fw-bold"></h4>
                    <div id="resRank" class="mb-3"></div>

                    <div class="row text-white border-top border-secondary pt-3">
                        <div class="col-6 border-end border-secondary">
                            <small class="d-block text-muted">Điểm tích lũy</small>
                            <span class="fw-bold fs-4 text-warning" id="resPoint"></span>
                        </div>
                        <div class="col-6">
                            <small class="d-block text-muted">Tổng chi tiêu</small>
                            <span class="fw-bold fs-4 text-info" id="resSpend"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #1a1a2e; border: 1px solid #00f2fe; color: white;">
            <div class="modal-header" style="border-bottom: 1px solid #2a2a4e;">
                <h5 class="modal-title">📅 ĐẶT BÀN BI-A</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <input type="hidden" id="bookMaBan" name="maBan" />

                    <div class="mb-3">
                        <label class="form-label text-info">Bàn số:</label>
                        <span id="bookTenBan" class="fw-bold fs-5 text-white"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Giờ đến dự kiến:</label>
                        <input type="datetime-local" id="bookThoiGian" class="form-control" required 
                               style="background: #16213e; border: 1px solid #4facfe; color: white;">
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Thời lượng:</label>
                            <select id="bookSoGio" class="form-select" style="background: #1a1a2e; color: white; border: 1px solid #4facfe;">
                                <option value="1">1 Giờ</option>
                                <option value="2">2 Giờ</option>
                                <option value="3">3 Giờ</option>
                                <option value="4">4 Giờ</option>
                                <option value="5">5+ Giờ</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Số người:</label>
                            <input type="number" id="bookSoNguoi" class="form-control" value="2" min="1" max="10"
                                   style="background: #1a1a2e; color: white; border: 1px solid #4facfe;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi chú (nếu có):</label>
                        <textarea id="bookGhiChu" class="form-control" rows="3" placeholder="Ví dụ: Cần 5 gậy, nước ngọt..."
                                  style="background: #16213e; border: 1px solid #4facfe; color: white;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #2a2a4e;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-info fw-bold" onclick="submitBooking()" style="background: #00f2fe; border: none;">XÁC NHẬN ĐẶT</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
        <script>

    // Hàm mở Modal (Gắn vào nút Đặt bàn)
        function bookTable(maBan, tenBan) {
            document.getElementById('bookMaBan').value = maBan;
            document.getElementById('bookTenBan').innerText = tenBan || ("Bàn " + maBan);

            // Set giờ mặc định là hiện tại
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('bookThoiGian').value = now.toISOString().slice(0, 16);

            new bootstrap.Modal(document.getElementById('bookingModal')).show();
        }

        // Hàm gửi dữ liệu
        async function submitBooking() {
            const maBan = document.getElementById('bookMaBan').value;
            const thoiGian = document.getElementById('bookThoiGian').value;
            const ghiChu = document.getElementById('bookGhiChu').value;
            const soGio = document.getElementById('bookSoGio').value;
            const soNguoi = document.getElementById('bookSoNguoi').value;

            if (!thoiGian) { alert("Vui lòng chọn giờ đến"); return; }

            // Dữ liệu gửi đi
            const formData = new FormData();
            formData.append('maBan', maBan);
            formData.append('thoiGian', thoiGian);
            formData.append('ghiChu', ghiChu);
            formData.append('soGio', soGio);
            formData.append('soNguoi', soNguoi);

            try {
                const response = await fetch('/Users/DatBan', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    // Đóng modal trước
                    const modalEl = document.getElementById('bookingModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();

                    // Hiện thông báo đẹp
                    Swal.fire({
                        title: 'Đặt bàn thành công!',
                        text: 'Vui lòng đến đúng giờ. Nhân viên sẽ giữ bàn cho bạn.',
                        icon: 'success',
                        background: '#16213e', // Màu nền tối
                        color: '#fff', // Chữ trắng
                        confirmButtonColor: '#00f2fe', // Màu nút xanh neon
                        confirmButtonText: 'Tuyệt vời!'
                    }).then((result) => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                            title: 'Không thành công',
                            text: result.message,
                            icon: 'error',
                            background: '#16213e',
                            color: '#fff'
                        });
                }
            } catch (err) {
                alert("Lỗi kết nối server!");
            }
        }

            async function lookupMember() {
                const sdt = document.getElementById('sdtInput').value;
                if (!sdt) { alert('Vui lòng nhập SĐT!'); return; }

                // URL gọi về Controller Users, Action TraCuuThanhVien
                const url = '/Users/TraCuuThanhVien?sdt=' + sdt;

                try {
                    const response = await fetch(url);
                    const result = await response.json();

                    if (result.success) {
                        const data = result.data;
                        document.getElementById('resName').innerText = data.ten;
                        document.getElementById('resRank').innerHTML = `<span class="badge bg-warning text-dark">${data.hang}</span>`;
                        document.getElementById('resPoint').innerText = data.diem;
                        document.getElementById('resSpend').innerText = data.chiTieu;
                        document.getElementById('resAvatar').src = data.avatar;

                        // Hiệu ứng hiện ra
                        document.getElementById('memberResult').style.display = 'block';
                    } else {
                        alert(result.message);
                        document.getElementById('memberResult').style.display = 'none';
                    }
                } catch (error) {
                    console.error(error);
                    alert('Lỗi kết nối!');
                }
            }
        </script>
}