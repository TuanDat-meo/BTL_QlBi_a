@using BTL_QlBi_a.Extensions
@using BTL_QlBi_a.Models.Entities
@model IEnumerable<BTL_QlBi_a.Models.Entities.BanBia>
@{
    ViewData["Title"] = "Trang chủ";
    var khuVucList = Model?.Select(b => b.KhuVuc).Distinct().Where(k => k != null).ToList() ?? new List<KhuVuc>();
}

<section class="page-section active" id="page-tables">
    <div class="section-header">
        <h2 class="section-title">Quản lý bàn</h2>
        <div class="action-buttons">
            <button class="btn btn-warning" onclick="openReservationModal()">Đặt bàn trước</button>
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-row">
            <div class="filter-group">
                <span class="filter-label">Khu vực:</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all" onclick="filterTables('all')">Tất cả</button>
                    @foreach (var kv in khuVucList)
                    {
                        <button class="filter-btn" data-filter="@kv.TenKhuVuc" onclick="filterTables('@kv.TenKhuVuc')">@kv.TenKhuVuc</button>
                    }
                </div>
            </div>

            <div class="filter-group">
                <span class="filter-label">Trạng thái:</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-status="all" onclick="filterStatus('all')">Tất cả</button>
                    <button class="filter-btn" data-status="Trong" onclick="filterStatus('Trong')">Trống</button>
                    <button class="filter-btn" data-status="DangChoi" onclick="filterStatus('DangChoi')">Đang chơi</button>
                    <button class="filter-btn" data-status="DaDat" onclick="filterStatus('DaDat')">Đã đặt</button>
                </div>
            </div>
        </div>

        <div class="filter-row">
            <input type="text" class="search-input" placeholder="Tìm kiếm bàn..." id="searchTables" onkeyup="searchTables()">
        </div>
    </div>

    <div style="background: #fff3cd; padding: 15px; margin: 20px 0; border-radius: 8px; border: 2px solid #ffc107;">
        <strong>🔍 DEBUG INFO:</strong><br>
        <div style="margin-top: 10px;">
            ✅ Tổng số bàn từ Model: <strong>@(Model?.Count() ?? 0)</strong><br>
            ✅ Bàn không bảo trì: <strong>@(Model?.Count(b => b.TrangThai != TrangThaiBan.BaoTri) ?? 0)</strong>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
            @if (Model != null && Model.Any())
            {
                <div>Danh sách bàn (5 bàn đầu):</div>
                @foreach (var b in Model.Take(5))
                {
                    <div>- @b.TenBan (@b.TrangThai.GetDisplayName()) - @(b.KhuVuc?.TenKhuVuc ?? "Không rõ")</div>
                }
            }
            else
            {
                <div style="color: red;">❌ Model NULL hoặc rỗng!</div>
            }
        </div>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="tables-grid" id="myTablesGrid">
            @foreach (var ban in Model.Where(b => b.TrangThai != TrangThaiBan.BaoTri))
            {
                // Xác định các class CSS dựa trên trạng thái (từ index.css)
                string statusClass = ban.TrangThai switch
                {
                    TrangThaiBan.Trong => "available",
                    TrangThaiBan.DangChoi => "occupied",
                    TrangThaiBan.DaDat => "reserved",
                    _ => ""
                };

                // Xác định các class CSS cho status text (từ index.css)
                string statusTextClass = ban.TrangThai switch
                {
                    TrangThaiBan.Trong => "status-available",
                    TrangThaiBan.DangChoi => "status-occupied",
                    TrangThaiBan.DaDat => "status-reserved",
                    _ => ""
                };

                string statusText = ban.TrangThai.GetDisplayName();
                string statusEnum = ban.TrangThai.ToString();
                string khuVucName = ban.KhuVuc?.TenKhuVuc ?? "Không rõ";
                bool isVIP = khuVucName.ToUpper().Contains("VIP");

                <div class="table-card @statusClass"
                     data-area="@khuVucName"
                     data-status="@statusEnum"
                     onclick="showTableDetail(@ban.MaBan)">

                    @* Badge VIP *@
                    @if (isVIP)
                    {
                        <span class="vip-badge">⭐ VIP</span>
                    }

                    <div class="table-name">@ban.TenBan</div>
                    <div class="table-status @statusTextClass">@statusText</div>

                    @* Thông tin chi tiết tùy theo trạng thái *@
                    @if (ban.TrangThai == TrangThaiBan.DangChoi)
                    {
                        if (ban.GioBatDau.HasValue)
                        {
                            var duration = DateTime.Now - ban.GioBatDau.Value;
                            <div class="table-info">👤 Khách: <strong>@(ban.KhachHang?.TenKH ?? "Khách lẻ")</strong></div>
                            <div class="table-timer">⏱️ @((int)duration.TotalHours)h @(duration.Minutes)m</div>
                        }
                    }
                    else if (ban.TrangThai == TrangThaiBan.DaDat)
                    {
                        if (!string.IsNullOrEmpty(ban.GhiChu))
                        {
                            <div class="table-info">📅 @ban.GhiChu</div>
                        }
                        if (ban.KhachHang != null)
                        {
                            <div class="table-info">👤 Khách: <strong>@ban.KhachHang.TenKH</strong></div>
                        }
                    }
                    else // Trong
                    {
                        <div class="table-info">Loại: @(ban.LoaiBan?.TenLoai ?? "Không rõ")</div>
                        <div class="table-price">@(ban.LoaiBan?.GiaGio.ToString("N0") ?? "0") đ/giờ</div>
                    }

                    @* Action Buttons - Sử dụng class btn đã định nghĩa *@
                    <div class="action-buttons">
                        @if (ban.TrangThai == TrangThaiBan.Trong)
                        {
                            <button class="btn btn-success" onclick="event.stopPropagation(); startTable(@ban.MaBan)">
                                ▶️ Bắt đầu
                            </button>
                        }
                        else if (ban.TrangThai == TrangThaiBan.DangChoi)
                        {
                            <button class="btn btn-primary" onclick="event.stopPropagation(); addService(@ban.MaBan)">
                                ➕ DV
                            </button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); endTable(@ban.MaBan)">
                                ⏹️ Kết thúc
                            </button>
                        }
                        else if (ban.TrangThai == TrangThaiBan.DaDat)
                        {
                            <button class="btn btn-success" onclick="event.stopPropagation(); confirmReservation(@ban.MaBan)">
                                ✅ Xác nhận
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">🎱</div>
            <h3 class="empty-text">Không có bàn nào</h3>
            <p class="empty-text">Chưa có bàn bi-a trong hệ thống</p>
        </div>
    }
</section>

<script>
    console.log('=== TRANG CHỦ LOADED ===');
    console.log('Model count:', @(Model?.Count() ?? 0));
    console.log('Cards on page:', document.querySelectorAll('.table-card').length);

    function filterTables(area) {
        console.log('Filter by area:', area);
        const cards = document.querySelectorAll('.table-card');
        const buttons = document.querySelectorAll('.filter-btn[data-filter]');

        buttons.forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector('.filter-btn[data-filter="' + area + '"]');
        if (activeBtn) activeBtn.classList.add('active');

        const currentStatus = document.querySelector('.filter-btn[data-status].active')?.dataset.status || 'all';
        const searchValue = document.getElementById('searchTables').value.toLowerCase();
        let visibleCount = 0;
        cards.forEach(card => {
            const cardArea = card.dataset.area;
            const cardStatus = card.dataset.status;
            const tableName = card.querySelector('.table-name')?.textContent.toLowerCase() || '';

            const areaMatch = (area === 'all' || cardArea === area);
            const statusMatch = (currentStatus === 'all' || cardStatus === currentStatus);
            const searchMatch = (searchValue === '' || tableName.includes(searchValue));

            if (areaMatch && statusMatch && searchMatch) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        console.log('Visible cards:', visibleCount);
    }

    function filterStatus(status) {
        console.log('Filter by status:', status);
        const cards = document.querySelectorAll('.table-card');
        const buttons = document.querySelectorAll('.filter-btn[data-status]');

        buttons.forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector('.filter-btn[data-status="' + status + '"]');
        if (activeBtn) activeBtn.classList.add('active');

        const currentArea = document.querySelector('.filter-btn[data-filter].active')?.dataset.filter || 'all';
        const searchValue = document.getElementById('searchTables').value.toLowerCase();

        cards.forEach(card => {
            const cardArea = card.dataset.area;
            const cardStatus = card.dataset.status;
            const tableName = card.querySelector('.table-name')?.textContent.toLowerCase() || '';

            const areaMatch = (currentArea === 'all' || cardArea === currentArea);
            const statusMatch = (status === 'all' || cardStatus === status);
            const searchMatch = (searchValue === '' || tableName.includes(searchValue));

            card.style.display = (areaMatch && statusMatch && searchMatch)
            ? 'block' : 'none';
        });
    }

    function searchTables() {
        const searchValue = document.getElementById('searchTables').value.toLowerCase();
        console.log('Search:', searchValue);
        filterTables(document.querySelector('.filter-btn[data-filter].active')?.dataset.filter || 'all');
    }

    function showTableDetail(maBan) {
        console.log('Show detail for table:', maBan);
        window.location.href = '/Home/ChiTietBan?maBan=' + maBan;
    }

    function startTable(maBan) {
        console.log('Start table:', maBan);
        alert('Bắt đầu chơi bàn: ' + maBan);
    }

    function addService(maBan) {
        console.log('Add service to table:', maBan);
        alert('Thêm dịch vụ cho bàn: ' + maBan);
    }

    function endTable(maBan) {
        console.log('End table:', maBan);
        if (confirm('Kết thúc và thanh toán?')) {
            alert('Thanh toán bàn: ' + maBan);
        }
    }

    function confirmReservation(maBan) {
        console.log('Confirm reservation:', maBan);
        if (confirm('Xác nhận khách đã đến?')) {
            alert('Xác nhận bàn: ' + maBan);
        }
    }

    function openReservationModal() {
        alert('Mở form đặt bàn trước');
    }

    // Auto run on load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Ready');
        filterTables('all');
    });
</script>