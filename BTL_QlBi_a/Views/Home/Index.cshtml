@using BTL_QlBi_a.Extensions
@using BTL_QlBi_a.Models.Entities
@model IEnumerable<BTL_QlBi_a.Models.Entities.BanBia>
@{
    ViewData["Title"] = "Quản lý bàn";
    var khuVucList = Model?.Select(b => b.KhuVuc).Distinct().Where(k => k != null).ToList() ?? new List<KhuVuc>();
}

@section Styles {
    <link rel="stylesheet" href="~/asset/css/table.css" />
}

<section class="page-section active" id="page-tables">
    <div class="section-header">
        <h2 class="section-title">Quản lý bàn</h2>
        <div class="action-buttons">
            <button class="btn btn-warning" onclick="openReservationModal()">📅 Đặt bàn trước</button>
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-row">
            <div class="filter-group">
                <span class="filter-label">Khu vực:</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all" onclick="filterTables('all')">Tất cả</button>
                    @foreach (var kv in khuVucList)
                    {
                        <button class="filter-btn" data-filter="@kv.TenKhuVuc" onclick="filterTables('@kv.TenKhuVuc')">@kv.TenKhuVuc</button>
                    }
                </div>
            </div>

            <div class="filter-group">
                <span class="filter-label">Trạng thái:</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-status="all" onclick="filterStatus('all')">Tất cả</button>
                    <button class="filter-btn" data-status="Trong" onclick="filterStatus('Trong')">Trống</button>
                    <button class="filter-btn" data-status="DangChoi" onclick="filterStatus('DangChoi')">Đang chơi</button>
                    <button class="filter-btn" data-status="DaDat" onclick="filterStatus('DaDat')">Đã đặt</button>
                </div>
            </div>
        </div>

        <div class="filter-row">
            <input type="text" class="search-input" placeholder="🔍 Tìm kiếm bàn..." id="searchTables" onkeyup="searchTables()">
        </div>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="tables-grid" id="myTablesGrid">
            @foreach (var ban in Model.Where(b => b.TrangThai != TrangThaiBan.BaoTri))
            {
                string statusBadgeClass = ban.TrangThai switch
                {
                    TrangThaiBan.Trong => "status-badge available",
                    TrangThaiBan.DangChoi => "status-badge occupied",
                    TrangThaiBan.DaDat => "status-badge reserved",
                    _ => "status-badge"
                };

                string statusText = ban.TrangThai.GetDisplayName();
                string statusEnum = ban.TrangThai.ToString();
                string khuVucName = ban.KhuVuc?.TenKhuVuc ?? "Không rõ";
                bool isVIP = khuVucName.ToUpper().Contains("VIP");

                <div class="table-card"
                     data-area="@khuVucName"
                     data-status="@statusEnum"
                     onclick="showTableDetail(@ban.MaBan)">

                    <div class="table-image">
                        @{
                            var imagePath = !string.IsNullOrEmpty(ban.HinhAnh)
                            ? Url.Content($"~/asset/img/{ban.HinhAnh}")
                            : Url.Content("~/asset/img/ban_mik_libre_Phan.jpg");
                        }

                        <img src="@imagePath"
                             alt="@ban.TenBan"
                             class="table-img"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />

                        <div class="placeholder-icon" style="display: none;">🎱</div>

                        <!-- Hiển thị trạng thái trên ảnh (bên trái) -->
                        <span class="@statusBadgeClass">@statusText</span>

                        <!-- VIP badge vẫn ở bên phải -->
                        @if (isVIP)
                        {
                            <span class="vip-badge">⭐ VIP</span>
                        }
                    </div>

                    <div class="table-content">
                        <div class="table-header">
                            <div class="table-name">@ban.TenBan</div>
                        </div>

                        @if (ban.TrangThai == TrangThaiBan.DangChoi)
                        {
                            if (ban.GioBatDau.HasValue)
                            {
                                var duration = DateTime.Now - ban.GioBatDau.Value;
                                <div class="table-info">👤 <strong>@(ban.KhachHang?.TenKH ?? "Khách lẻ")</strong></div>
                                <div class="table-timer">⏱️ @((int)duration.TotalHours)h @(duration.Minutes)m</div>
                            }
                        }
                        else if (ban.TrangThai == TrangThaiBan.DaDat)
                        {
                            if (!string.IsNullOrEmpty(ban.GhiChu))
                            {
                                <div class="table-info">📅 @ban.GhiChu</div>
                            }
                            if (ban.KhachHang != null)
                            {
                                <div class="table-info">👤 <strong>@ban.KhachHang.TenKH</strong></div>
                            }
                        }
                        else
                        {
                            <div class="table-info">@(ban.LoaiBan?.TenLoai ?? "Không rõ")</div>
                            <div class="table-price">@(ban.LoaiBan?.GiaGio.ToString("N0") ?? "0") đ/giờ</div>
                        }

                        <div class="action-buttons">
                            @if (ban.TrangThai == TrangThaiBan.Trong)
                            {
                                <button class="btn btn-success" onclick="event.stopPropagation(); startTable(@ban.MaBan)">
                                    ▶️ Bắt đầu
                                </button>
                            }
                            else if (ban.TrangThai == TrangThaiBan.DangChoi)
                            {
                                <button class="btn btn-primary" onclick="event.stopPropagation(); addService(@ban.MaBan)">
                                    ➕ Dịch vụ
                                </button>
                                <button class="btn btn-danger" onclick="event.stopPropagation(); endTable(@ban.MaBan)">
                                    ⏹️ Kết thúc
                                </button>
                            }
                            else if (ban.TrangThai == TrangThaiBan.DaDat)
                            {
                                <button class="btn btn-success" onclick="event.stopPropagation(); confirmReservation(@ban.MaBan)">
                                    ✅ Xác nhận
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">🎱</div>
            <h3>Không có bàn nào</h3>
            <p class="empty-text">Chưa có bàn bi-a trong hệ thống</p>
        </div>
    }
</section>

@section Scripts {
    <script>
        console.log('=== QUẢN LÝ BÀN LOADED ===');
        console.log('Cards on page:', document.querySelectorAll('.table-card').length);

        function filterTables(area) {
            const cards = document.querySelectorAll('.table-card');
            const buttons = document.querySelectorAll('.filter-btn[data-filter]');

            buttons.forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector('.filter-btn[data-filter="' + area + '"]');
            if (activeBtn) activeBtn.classList.add('active');

            const currentStatus = document.querySelector('.filter-btn[data-status].active')?.dataset.status || 'all';
            const searchValue = document.getElementById('searchTables').value.toLowerCase();

            cards.forEach(card => {
                const cardArea = card.dataset.area;
                const cardStatus = card.dataset.status;
                const tableName = card.querySelector('.table-name')?.textContent.toLowerCase() || '';

                const areaMatch = (area === 'all' || cardArea === area);
                const statusMatch = (currentStatus === 'all' || cardStatus === currentStatus);
                const searchMatch = (searchValue === '' || tableName.includes(searchValue));

                card.style.display = (areaMatch && statusMatch && searchMatch) ? 'block' : 'none';
            });
        }

        function filterStatus(status) {
            const cards = document.querySelectorAll('.table-card');
            const buttons = document.querySelectorAll('.filter-btn[data-status]');

            buttons.forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector('.filter-btn[data-status="' + status + '"]');
            if (activeBtn) activeBtn.classList.add('active');

            const currentArea = document.querySelector('.filter-btn[data-filter].active')?.dataset.filter || 'all';
            const searchValue = document.getElementById('searchTables').value.toLowerCase();

            cards.forEach(card => {
                const cardArea = card.dataset.area;
                const cardStatus = card.dataset.status;
                const tableName = card.querySelector('.table-name')?.textContent.toLowerCase() || '';

                const areaMatch = (currentArea === 'all' || cardArea === currentArea);
                const statusMatch = (status === 'all' || cardStatus === status);
                const searchMatch = (searchValue === '' || tableName.includes(searchValue));

                card.style.display = (areaMatch && statusMatch && searchMatch) ? 'block' : 'none';
            });
        }

        function searchTables() {
            filterTables(document.querySelector('.filter-btn[data-filter].active')?.dataset.filter || 'all');
        }

        function showTableDetail(maBan) {
            window.location.href = '/Home/ChiTietBan?maBan=' + maBan;
        }

        function startTable(maBan) {
            alert('Bắt đầu chơi bàn: ' + maBan);
        }

        function addService(maBan) {
            alert('Thêm dịch vụ cho bàn: ' + maBan);
        }

        function endTable(maBan) {
            if (confirm('Kết thúc và thanh toán?')) {
                alert('Thanh toán bàn: ' + maBan);
            }
        }

        function confirmReservation(maBan) {
            if (confirm('Xác nhận khách đã đến?')) {
                alert('Xác nhận bàn: ' + maBan);
            }
        }

        function openReservationModal() {
            alert('Mở form đặt bàn trước');
        }

        document.addEventListener('DOMContentLoaded', function() {
            filterTables('all');
        });
    </script>
}