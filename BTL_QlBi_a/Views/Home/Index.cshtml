@model IEnumerable<BTL_QlBi_a.Models.Entities.BanBia>
@{
    ViewData["Title"] = "Quản lý bàn";
}

@section Styles {
    <link rel="stylesheet" href="~/asset/css/table.css" />
}

<<<<<<< HEAD
@* Render partial view cho Quản lý bàn *@
@await Html.PartialAsync("Partials/_QuanLyBan", Model)
=======
<section class="page-section active" id="page-tables">
    <div class="section-header">
        <h2 class="section-title">Quản lý bàn</h2>
        <div class="action-buttons">
            <button class="btn btn-warning" onclick="openReservationModal()">📅 Đặt bàn trước</button>
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-row">
            <div class="filter-group">
                <span class="filter-label">Khu vực:</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all" onclick="filterTables('all')">Tất cả</button>
                    <button class="filter-btn" data-filter="Tầng 1" onclick="filterTables('Tầng 1')">Tầng 1</button>
                    <button class="filter-btn" data-filter="Tầng 2" onclick="filterTables('Tầng 2')">Tầng 2</button>
                    <button class="filter-btn" data-filter="VIP" onclick="filterTables('VIP')">VIP</button>
                </div>
            </div>

            <div class="filter-group">
                <span class="filter-label">Trạng thái:</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-status="all" onclick="filterStatus('all')">Tất cả</button>
                    <button class="filter-btn" data-status="Trong" onclick="filterStatus('Trong')">Trống</button>
                    <button class="filter-btn" data-status="DangChoi" onclick="filterStatus('DangChoi')">Đang chơi</button>
                    <button class="filter-btn" data-status="DaDat" onclick="filterStatus('DaDat')">Đã đặt</button>
                </div>
            </div>
        </div>

        <div class="filter-row">
            <input type="text" class="search-input" placeholder="🔍 Tìm kiếm bàn..." id="searchTables" onkeyup="searchTables()">
        </div>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="tables-grid" id="myTablesGrid">
            @foreach (var ban in Model.Where(b => b.TrangThai != BTL_QlBi_a.Models.Entities.TrangThaiBan.BaoTri))
            {
                string statusBadgeClass = ban.TrangThai switch
                {
                    BTL_QlBi_a.Models.Entities.TrangThaiBan.Trong => "status-badge available",
                    BTL_QlBi_a.Models.Entities.TrangThaiBan.DangChoi => "status-badge occupied",
                    BTL_QlBi_a.Models.Entities.TrangThaiBan.DaDat => "status-badge reserved",
                    _ => "status-badge"
                };

                string statusText = ban.TrangThai switch
                {
                    BTL_QlBi_a.Models.Entities.TrangThaiBan.Trong => "Trống",
                    BTL_QlBi_a.Models.Entities.TrangThaiBan.DangChoi => "Đang chơi",
                    BTL_QlBi_a.Models.Entities.TrangThaiBan.DaDat => "Đã đặt",
                    _ => ban.TrangThai.ToString()
                };

                <div class="table-card"
                     data-area="@ban.KhuVuc?.TenKhuVuc"
                     data-status="@ban.TrangThai"
                     onclick="showTableDetail(@ban.MaBan)">

                    <div class="table-image">
                        @{
                            var imagePath = !string.IsNullOrEmpty(ban.HinhAnh)
                            ? Url.Content($"~/asset/img/{ban.HinhAnh}")
                            : Url.Content("~/asset/img/ban_mik_libre_Phan.jpg");
                        }

                        <img src="@imagePath"
                             alt="@ban.TenBan"
                             class="table-img"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />

                        <div class="placeholder-icon" style="display: none;">🎱</div>

                        <!-- Hiển thị trạng thái trên ảnh (bên trái) -->
                        <span class="@statusBadgeClass">@statusText</span>

                        <!-- VIP badge vẫn ở bên phải -->
                        @if (ban.KhuVuc?.TenKhuVuc == "VIP")
                        {
                            <span class="vip-badge">⭐ VIP</span>
                        }
                    </div>

                    <div class="table-content">
                        <div class="table-header">
                            <div class="table-name">@ban.TenBan</div>
                        </div>

                        @if (ban.TrangThai == BTL_QlBi_a.Models.Entities.TrangThaiBan.DangChoi)
                        {
                            if (ban.GioBatDau.HasValue)
                            {
                                var duration = DateTime.Now - ban.GioBatDau.Value;
                                <div class="table-info">👤 <strong>@(ban.KhachHang?.TenKH ?? "Khách lẻ")</strong></div>
                                <div class="table-timer">⏱️ @((int)duration.TotalHours)h @(duration.Minutes)m</div>
                            }
                        }
                        else if (ban.TrangThai == BTL_QlBi_a.Models.Entities.TrangThaiBan.DaDat)
                        {
                            if (!string.IsNullOrEmpty(ban.GhiChu))
                            {
                                <div class="table-info">📅 @ban.GhiChu</div>
                            }
                            if (ban.KhachHang != null)
                            {
                                <div class="table-info">👤 <strong>@ban.KhachHang.TenKH</strong></div>
                            }
                        }
                        else
                        {
                            <div class="table-info">@(ban.LoaiBan?.TenLoai ?? "Không rõ")</div>
                            <div class="table-price">@(ban.LoaiBan?.GiaGio.ToString("N0") ?? "0") đ/giờ</div>
                        }

                        <div class="action-buttons">
                            @if (ban.TrangThai == BTL_QlBi_a.Models.Entities.TrangThaiBan.Trong)
                            {
                                <button class="btn btn-success" onclick="event.stopPropagation(); startTable(@ban.MaBan)">
                                    ▶️ Bắt đầu
                                </button>
                            }
                            else if (ban.TrangThai == BTL_QlBi_a.Models.Entities.TrangThaiBan.DangChoi)
                            {
                                <button class="btn btn-primary" onclick="event.stopPropagation(); addService(@ban.MaBan)">
                                    ➕ Dịch vụ
                                </button>
                                <button class="btn btn-danger" onclick="event.stopPropagation(); endTable(@ban.MaBan)">
                                    ⏹️ Kết thúc
                                </button>
                            }
                            else if (ban.TrangThai == BTL_QlBi_a.Models.Entities.TrangThaiBan.DaDat)
                            {
                                <button class="btn btn-success" onclick="event.stopPropagation(); confirmReservation(@ban.MaBan)">
                                    ✅ Xác nhận
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">🎱</div>
            <h3>Không có bàn nào</h3>
            <p class="empty-text">Chưa có bàn bi-a trong hệ thống</p>
        </div>
    }
</section>
>>>>>>> e7f15b64503b8426516cf40bbd21e1680e35d641

@section Scripts {
    <script src="~/asset/js/quanlyban.js"></script>
    <script>
        // Test debug
        console.log('Page loaded');
        console.log('Detail Panel:', document.getElementById('detailPanel'));
        console.log('Table Cards:', document.querySelectorAll('.table-card').length);
    </script>
}