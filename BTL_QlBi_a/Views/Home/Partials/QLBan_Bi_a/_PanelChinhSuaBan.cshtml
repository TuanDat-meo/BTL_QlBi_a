@model BTL_QlBi_a.Models.Entities.BanBia
<link rel="stylesheet" href="~/asset/css/qlBan/chinhSuaBan.css" />
@{
    var hoaDon = ViewBag.HoaDon as BTL_QlBi_a.Models.Entities.HoaDon;
    var chiTiet = ViewBag.ChiTietDichVu as List<BTL_QlBi_a.Models.Entities.ChiTietHoaDon>;
    var giaGio = Model.LoaiBan?.GiaGio ?? 0;
}

<div class="edit-panel-wrapper">
    <div class="panel-header">
        <h3 class="panel-title">✏️ Chỉnh sửa bàn @Model.TenBan</h3>
        <button class="btn-close-menu" onclick="EditTableManager.close()">✕</button>
    </div>

    <div class="panel-body-scroll">
        @if (hoaDon != null)
        {
            // Tính thời gian chơi THỰC TẾ
            var duration = DateTime.Now - hoaDon.ThoiGianBatDau.Value;
            var hours = (int)duration.TotalHours;
            var minutes = duration.Minutes;

            // Tính tiền theo thời gian THỰC TẾ
            var totalMinutes = duration.TotalMinutes;
            var soGioThucTe = totalMinutes / 60;
            var tienBanThucTe = giaGio * (decimal)soGioThucTe;

            <!-- Chỉnh sửa giờ bắt đầu -->
            <div class="edit-section" data-gia-gio="@giaGio">
                <h4 class="section-subtitle">Thông tin thời gian</h4>
                <div class="form-group">
                    <label class="form-label">Giờ bắt đầu:</label>
                    <input type="datetime-local" class="form-control" id="gioBatDau"
                           value="@hoaDon.ThoiGianBatDau.Value.ToString("yyyy-MM-ddTHH:mm")">
                </div>

                <div class="info-display">
                    <div class="info-row">
                        <span>Thời gian chơi:</span>
                        <strong id="currentDuration">@hours giờ @minutes phút</strong>
                    </div>
                    <div class="info-row">
                        <span>Giá bàn:</span>
                        <strong>@giaGio.ToString("N0") đ/giờ</strong>
                    </div>
                </div>

                <button class="btn btn-primary btn-block" onclick="EditTableManager.save(@Model.MaBan)">
                    💾 Lưu thay đổi giờ
                </button>
            </div>

            <!-- Danh sách dịch vụ đã order -->
            if (chiTiet != null && chiTiet.Any())
            {
                <div class="edit-section">
                    <h4 class="section-subtitle">Dịch vụ đã order</h4>
                    <div class="service-list-edit">
                        @foreach (var item in chiTiet)
                        {
                            <div class="service-item-edit" data-id="@item.ID">
                                <div class="service-info">
                                    <div class="service-name">@item.DichVu?.TenDV</div>
                                    <div class="service-details">
                                        <span class="service-price">@item.DichVu?.Gia.ToString("N0") đ × @item.SoLuong</span>
                                    </div>
                                </div>
                                <div class="service-controls">
                                    <div class="quantity-control">
                                        <button class="qty-btn" onclick="EditTableManager.decreaseQuantity(@item.ID, @Model.MaBan)">-</button>
                                        <input type="number" class="qty-input" id="qty-@item.ID"
                                               value="@item.SoLuong" min="1" max="99" readonly>
                                        <button class="qty-btn" onclick="EditTableManager.increaseQuantity(@item.ID, @Model.MaBan)">+</button>
                                    </div>
                                    <button class="btn-delete-service" onclick="EditTableManager.removeService(@item.ID, @Model.MaBan)" title="Xóa">
                                        🗑️
                                    </button>
                                </div>
                                <div class="service-total">
                                    Tổng: <strong id="total-@item.ID">@item.ThanhTien?.ToString("N0") đ</strong>
                                </div>
                            </div>
                        }
                    </div>
                    <button class="btn btn-success btn-block" onclick="TableManager.addService(@Model.MaBan)">
                        ➕ Thêm dịch vụ mới
                    </button>
                </div>
            }
            else
            {
                <div class="edit-section">
                    <h4 class="section-subtitle">Dịch vụ đã order</h4>
                    <div class="empty-state">
                        <p style="text-align: center; color: #999; padding: 20px;">Chưa có dịch vụ nào</p>
                    </div>
                    <button class="btn btn-success btn-block" onclick="TableManager.addService(@Model.MaBan)">
                        ➕ Thêm dịch vụ mới
                    </button>
                </div>
            }

            // Tính tổng tiền
            var tongDichVu = chiTiet?.Sum(ct => ct.ThanhTien ?? 0) ?? 0;
            var tongTienTruocLamTron = tienBanThucTe + tongDichVu - hoaDon.GiamGia;
            var tongTienSauLamTron = Math.Ceiling(tongTienTruocLamTron / 1000) * 1000;

            <!-- Tổng tiền hiện tại -->
            <div class="bill-summary">
                <div class="summary-row">
                    <span>Tiền bàn:</span>
                    <span id="tienBanUocTinh">@tienBanThucTe.ToString("N0") đ</span>
                </div>
                <div class="summary-row">
                    <span>Tiền dịch vụ:</span>
                    <input type="hidden" id="tienDichVu" value="@hoaDon.TienDichVu">
                    <span>@hoaDon.TienDichVu.ToString("N0") đ</span>
                </div>
                <div class="summary-row">
                    <span>Giảm giá:</span>
                    <input type="hidden" id="giamGia" value="@hoaDon.GiamGia">
                    <span>-@hoaDon.GiamGia.ToString("N0") đ</span>
                </div>
                <div class="summary-row total">
                    <span>TỔNG CỘNG:</span>
                    <span id="tongTienUocTinh">@tongTienSauLamTron.ToString("N0") đ</span>
                </div>
                <div class="summary-note">
                    <small style="color: #999;">* Tiền bàn tính theo thời gian thực tế</small><br>
                    <small style="color: #999;">* Tổng tiền làm tròn lên nghìn</small>
                </div>
            </div>
        }
        else
        {
            <div class="empty-state">
                <p>Bàn chưa có hóa đơn để chỉnh sửa</p>
            </div>
        }

        <div class="action-section">
            <button class="btn btn-secondary btn-block" onclick="EditTableManager.close()">
                Đóng
            </button>
        </div>
    </div>
</div>

<script src="~/asset/js/qlBan/chinhSuaBan.js"></script>