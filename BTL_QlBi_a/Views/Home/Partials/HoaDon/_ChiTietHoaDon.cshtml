@model BTL_QlBi_a.Models.Entities.HoaDon
<link href="~/asset/css/qlBan/chiTietBan.css?v=@DateTime.Now.Ticks" rel="stylesheet" />
<link href="~/asset/css/qlHoaDon/chiTietHoaDon.css" rel="stylesheet" />

@{
    // Dữ liệu chung
    var chiTiet = ViewBag.ChiTietDichVu as List<BTL_QlBi_a.Models.Entities.ChiTietHoaDon> ?? new List<BTL_QlBi_a.Models.Entities.ChiTietHoaDon>();

    // 1. LẤY LOGIC QUYỀN (Từ _ChiTietBan)
    var tenNhom = ViewBag.TenNhom as string ?? "Nhân viên";
    bool isAdmin = tenNhom == "Admin";
    bool isQuanLy = tenNhom == "Quản lý" || isAdmin;
    bool isThuNgan = tenNhom == "Thu ngân" || isQuanLy;
    bool isPhucVu = tenNhom == "Phục vụ";

    // 2. XÁC ĐỊNH TRẠNG THÁI
    bool isDangChoi = Model.TrangThai == BTL_QlBi_a.Models.Entities.TrangThaiHoaDon.DangChoi;

    string statusBadgeClass = isDangChoi ? "status-badge occupied" : "status-badge available";
    string statusText = isDangChoi ? "Đang chơi" : "Đã thanh toán";

    // Giá trị mặc định cho các biến hiển thị
    decimal giaGio = 0m;
    decimal tienBanThucTe = 0m;
    int hours = 0;
    int minutes = 0;
    double soGioThucTe = 0.0;
    decimal tongDichVu = 0m;
    decimal tongTienTruocLamTron = 0m;
    decimal tongTienSauLamTron = 0m;
    decimal chenhLech = 0m;
    DateTime? thoiGianBatDau = Model.ThoiGianBatDau;

    if (isDangChoi && thoiGianBatDau.HasValue)
    {
        var duration = DateTime.Now - thoiGianBatDau.Value;
        var totalMinutes = duration.TotalMinutes;
        soGioThucTe = totalMinutes / 60.0;

        giaGio = Model.BanBia?.LoaiBan?.GiaGio ?? 0m;
        tienBanThucTe = giaGio * (decimal)soGioThucTe;

        hours = (int)duration.TotalHours;
        minutes = duration.Minutes;

        tongDichVu = chiTiet.Sum(ct => ct.ThanhTien ?? 0m);
        tongTienTruocLamTron = tienBanThucTe + tongDichVu;
        tongTienSauLamTron = Math.Ceiling(tongTienTruocLamTron / 1000m) * 1000m;
        chenhLech = tongTienSauLamTron - tongTienTruocLamTron;
    }
    else
    {
        // Hóa đơn đã thanh toán: lấy giá trị từ model (trong trường hợp Model.* có null, xử lý an toàn)
        tienBanThucTe = Model.TienBan;
        tongDichVu = Model.TienDichVu;
    }
}

<div class="detail-header">
    @if (isDangChoi)
    {
    <h3 class="detail-title">Tạm tính HD@(Model.MaHD.ToString("D4"))</h3>

    }
    else
    {
         <h3 class="detail-title">Hóa đơn HD@(Model.MaHD.ToString("D4"))</h3>
    }
    <span class="@statusBadgeClass">@statusText</span>
</div>

<div class="detail-body">
    @if (isDangChoi)
    {
            <div class="info-section">
                <div class="info-row">
                    <span class="info-label">Bàn:</span>
                    <span class="info-value">@(Model.BanBia?.TenBan ?? "N/A")</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Khách hàng:</span>
                    <span class="info-value">@(Model.KhachHang?.TenKH ?? "Khách lẻ")</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Bắt đầu:</span>
                    <span class="info-value">@((Model.ThoiGianBatDau.HasValue) ? Model.ThoiGianBatDau.Value.ToString("HH:mm dd/MM/yyyy") : "N/A")</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Thời gian:</span>
                    <span class="info-value time-highlight">@hours giờ @minutes phút</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Giá giờ:</span>
                    <span class="info-value">@giaGio.ToString("N0") đ/giờ</span>
                </div>
            </div>

            <div class="bill-section">
                <div class="bill-row">
                    <span>Tiền bàn:</span>
                    <span>@tienBanThucTe.ToString("N0") đ</span>
                </div>
                <div class="bill-row">
                    <span>Dịch vụ:</span>
                    <span>@tongDichVu.ToString("N0") đ</span>
                </div>
            @if (chenhLech > 0)
            {
                        <div class="bill-row" style="font-size: 0.9em; color: #666;">
                            <span>Tạm tính:</span>
                            <span>@tongTienSauLamTron.ToString("N0") đ</span>
                        </div>
            }
                <div class="bill-row total">
                    <span>Tổng cộng:</span>
                    <span>@tongTienSauLamTron.ToString("N0") đ</span>
                </div>
            </div>

        @if (chiTiet.Any())
        {
                    <div class="service-section">
                        <h4 class="section-subtitle">Dịch vụ đã order (@chiTiet.Count món):</h4>
                        <div class="service-list">
                    @foreach (var item in chiTiet)
                    {
                                    <div class="service-item">
                                        <div class="service-info">
                                            <div class="service-name">@item.DichVu?.TenDV</div>
                                            <div class="service-quantity">@item.SoLuong x @(item.DichVu?.Gia.ToString("N0") ?? "0") đ</div>
                                        </div>
                                        <div class="service-actions">
                                            <div class="service-price">@item.ThanhTien?.ToString("N0") đ</div>
                                @if (isPhucVu || isThuNgan)
                                {
                                                    <button class="btn-icon-sm btn-danger-icon" onclick="TableManager.removeService(@item.ID)" title="Xóa">×</button>
                                }
                                        </div>
                                    </div>
                    }
                        </div>
                    </div>
        }
        else
        {
                    <div class="service-section">
                        <p style="text-align: center; color: #999; padding: 20px;">Chưa có dịch vụ nào</p>
                    </div>
        }

            <div class="action-section">
            @if (isThuNgan)
            {
                <button class="btn btn-primary" onclick="printInvoice(@Model.MaHD)">🖨️ In hóa đơn tạm tính</button>
            }
            </div>
    }
    else
    {
            <div class="info-section">
                <div class="info-row">
                    <span class="info-label">Bàn:</span>
                    <span class="info-value">@(Model.BanBia?.TenBan ?? "N/A")</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Khách hàng:</span>
                    <span class="info-value">@(Model.KhachHang?.TenKH ?? "Khách lẻ")</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Nhân viên:</span>
                    <span class="info-value">@(Model.NhanVien?.TenNV ?? "N/A")</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Bắt đầu:</span>
                    <span class="info-value">@(Model.ThoiGianBatDau?.ToString("HH:mm dd/MM/yyyy") ?? "N/A")</span>
                </div>
            @if (Model.ThoiGianKetThuc != null)
            {
                        <div class="info-row">
                            <span class="info-label">Kết thúc:</span>
                            <span class="info-value">@Model.ThoiGianKetThuc.Value.ToString("HH:mm dd/MM/yyyy")</span>
                        </div>
            }
            </div>

        @if (chiTiet.Any())
        {
                    <div class="service-section">
                        <h4 class="section-subtitle">Dịch vụ đã sử dụng:</h4>
                @foreach (var item in chiTiet)
                {
                                <div class="service-item">
                                    <div class="service-name">@item.DichVu?.TenDV x @item.SoLuong</div>
                                    <div class="service-price">@item.ThanhTien?.ToString("N0") đ</div>
                                </div>
                }
                    </div>
        }

            <div class="bill-section">
                <div class="bill-row">
                    <span>Tiền bàn:</span>
                    <span>@Model.TienBan.ToString("N0") đ</span>
                </div>
                <div class="bill-row">
                    <span>Tiền dịch vụ:</span>
                    <span>@Model.TienDichVu.ToString("N0") đ</span>
                </div>
            @if (Model.GiamGia > 0)
            {
                        <div class="bill-row">
                            <span>Giảm giá:</span>
                            <span>-@Model.GiamGia.ToString("N0") đ</span>
                        </div>
            }
                <div class="bill-row total">
                    <span>Tổng cộng:</span>
                    <span>@Model.TongTien.ToString("N0") đ</span>
                </div>
            </div>

            <div class="action-section">
                <button class="btn btn-primary" onclick="printInvoice(@Model.MaHD)">🖨️ In hóa đơn</button>
            </div>
    }
</div>
