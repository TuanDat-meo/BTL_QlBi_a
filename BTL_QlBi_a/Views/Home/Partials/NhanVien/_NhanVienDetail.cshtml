@model BTL_QlBi_a.Models.Entities.NhanVien
@{
    var canManage = ViewBag.CurrentRole == "Admin" || ViewBag.CurrentRole == "Quản lý";
    var totalSalary = ViewBag.TotalSalary ?? 0m;
    var bonus = ViewBag.Bonus ?? 0m;
    var penalty = ViewBag.Penalty ?? 0m;
    var totalHours = ViewBag.TotalHours ?? 0m;
    var workDays = ViewBag.WorkDays ?? 0;
    var lateDays = ViewBag.LateDays ?? 0;
    var absentDays = ViewBag.AbsentDays ?? 0;
}

<div class="employee-detail">
    <!-- Header -->
    <div class="employee-detail-header">
        <div class="employee-detail-avatar">
            @if (!string.IsNullOrEmpty(Model.FaceIDAnh))
            {
                <img src="@Model.FaceIDAnh" alt="@Model.TenNV" />
            }
            else
            {
                @Model.TenNV.Substring(0, 1)
            }
        </div>
        <div class="employee-detail-info">
            <h3>@Model.TenNV</h3>
            <p>@Model.NhomQuyen.TenNhom • NV@(Model.MaNV.ToString("D4"))</p>
            <p>
                @if (Model.TrangThai == BTL_QlBi_a.Models.Entities.TrangThaiNhanVien.DangLam)
                {
                    <span style="background: rgba(255,255,255,0.3); padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                        ✓ Đang làm việc
                    </span>
                }
                else
                {
                    <span style="background: rgba(108,117,125,0.3); padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                        ✗ Nghỉ việc
                    </span>
                }
            </p>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons-grid">
        <button class="btn-icon btn-attendance" onclick="openAttendanceModal(@Model.MaNV)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Chấm công
        </button>
        <button class="btn-icon btn-schedule" onclick="openScheduleModal(@Model.MaNV)" @(!canManage ? "disabled" : "") >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            Xếp lịch
        </button>
        @if (canManage)
        {
            <button class="btn-icon" style="background: #ffc107; color: #000;" onclick="openEditEmployeeModal(@Model.MaNV)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Sửa
            </button>
            @if (Model.TrangThai == BTL_QlBi_a.Models.Entities.TrangThaiNhanVien.DangLam)
            {
                <button class="btn-icon" style="background: #dc3545; color: white;" onclick="deactivateEmployee(@Model.MaNV)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    Nghỉ việc
                </button>
            }
            else
            {
                <button class="btn-icon" style="background: #28a745; color: white;" onclick="activateEmployee(@Model.MaNV)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Làm lại
                </button>
            }
        }
    </div>

    <!-- Tabs -->
    <div class="detail-tabs">
        <button class="tab-btn active" data-tab="info">Thông tin</button>
        <button class="tab-btn" data-tab="salary">Lương</button>
        <button class="tab-btn" data-tab="attendance">Chấm công</button>
        <button class="tab-btn" data-tab="schedule">Lịch làm</button>
    </div>

    <!-- Tab: Thông tin -->
    <div class="tab-content active" id="tab-info">
        <div class="info-card">
            <div class="info-row">
                <div class="info-label">Số điện thoại:</div>
                <div class="info-value">@(Model.SDT ?? "Chưa cập nhật")</div>
            </div>
            <div class="info-row">
                <div class="info-label">Ca làm việc:</div>
                <div class="info-value">Ca @Model.CaMacDinh</div>
            </div>
            <div class="info-row">
                <div class="info-label">Lương cơ bản:</div>
                <div class="info-value">@Model.LuongCoBan.ToString("N0")đ</div>
            </div>
            <div class="info-row">
                <div class="info-label">Phụ cấp:</div>
                <div class="info-value">@Model.PhuCap.ToString("N0")đ</div>
            </div>
            <div class="info-row">
                <div class="info-label">Vân tay:</div>
                <div class="info-value">
                    @if (!string.IsNullOrEmpty(Model.MaVanTay))
                    {
                        <span style="color: #28a745;">✓ Đã đăng ký</span>
                    }
                    else
                    {
                        <span style="color: #6c757d;">✗ Chưa đăng ký</span>
                    }
                </div>
            </div>
            <div class="info-row">
                <div class="info-label">Face ID:</div>
                <div class="info-value">
                    @if (!string.IsNullOrEmpty(Model.FaceIDHash))
                    {
                        <span style="color: #28a745;">✓ Đã đăng ký</span>
                    }
                    else
                    {
                        <span style="color: #6c757d;">✗ Chưa đăng ký</span>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Lương -->
    <div class="tab-content" id="tab-salary">
        <div class="salary-card">
            <div class="salary-label">Tổng lương tháng này</div>
            <div class="salary-amount">@totalSalary.ToString("N0")đ</div>
            <div class="salary-breakdown">
                <div class="salary-item">
                    <div class="salary-item-label">Lương cơ bản</div>
                    <div class="salary-item-value">@Model.LuongCoBan.ToString("N0")đ</div>
                </div>
                <div class="salary-item">
                    <div class="salary-item-label">Phụ cấp</div>
                    <div class="salary-item-value">@Model.PhuCap.ToString("N0")đ</div>
                </div>
                <div class="salary-item">
                    <div class="salary-item-label">Thưởng</div>
                    <div class="salary-item-value">+@bonus.ToString("N0")đ</div>
                </div>
                <div class="salary-item">
                    <div class="salary-item-label">Phạt</div>
                    <div class="salary-item-value">-@penalty.ToString("N0")đ</div>
                </div>
            </div>
        </div>
        <div class="info-card" style="margin-top: 15px;">
            <div class="info-row">
                <div class="info-label">Tổng giờ làm:</div>
                <div class="info-value">@totalHours giờ</div>
            </div>
            <div class="info-row">
                <div class="info-label">Số ngày làm:</div>
                <div class="info-value">@workDays ngày</div>
            </div>
            <div class="info-row">
                <div class="info-label">Số lần trễ:</div>
                <div class="info-value" style="color: #ffc107;">@lateDays lần</div>
            </div>
            <div class="info-row">
                <div class="info-label">Số ngày vắng:</div>
                <div class="info-value" style="color: #dc3545;">@absentDays ngày</div>
            </div>
        </div>
        <div class="action-buttons" style="margin-top: 15px;">
            <button class="btn btn-primary" onclick="openSalaryDetailModal(@Model.MaNV)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Xem lịch sử lương
            </button>
            @if (canManage)
            {
                <button class="btn btn-success" onclick="calculateSalary(@Model.MaNV)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                    Tính lương tháng này
                </button>
            }
        </div>
    </div>

    <!-- Tab: Chấm công -->
    <div class="tab-content" id="tab-attendance">
        <div class="attendance-list" id="attendanceList">
            <div style="text-align: center; padding: 20px; color: #6c757d;">
                Đang tải...
            </div>
        </div>
    </div>

    <!-- Tab: Lịch làm -->
    <div class="tab-content" id="tab-schedule">
        <div class="schedule-calendar">
            <div class="calendar-header">
                <button class="btn btn-secondary btn-sm" onclick="previousMonth()">‹</button>
                <h4 id="currentMonth">Tháng @DateTime.Now.Month/@DateTime.Now.Year</h4>
                <button class="btn btn-secondary btn-sm" onclick="nextMonth()">›</button>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tab = this.dataset.tab;

            // Update active states
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            this.classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');

            // Load data for specific tabs
            if (tab === 'attendance') {
                loadAttendanceHistory(@Model.MaNV);
            } else if (tab === 'schedule') {
                loadScheduleCalendar(@Model.MaNV);
            }
        });
    });
</script>

<button class="btn-icon btn-faceid" onclick="openFaceIdModal(@Model.MaNV)" @(!canManage ? "disabled" : "")>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M5.52 19c.64-2.2 1.84-3 3.22-3h6.52c1.38 0 2.58.8 3.22 3"></path>
        <circle cx="12" cy="10" r="3"></circle>
        <circle cx="12" cy="12" r="10"></circle>
    </svg>
    Face ID
</button>
<button class="btn-icon btn-fingerprint" onclick="openFingerprintModal(@Model.MaNV)" @(!canManage ? "disabled" : "")>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M2 12C2 6.5 6.5 2 12 2a10 10 0 0 1 8 4"></path>
        <path d="M5 19.5C5.5 18 6 15 6 12c0-.7.12-1.37.34-2"></path>
        <path d="M17.29 21.02c.12-.6.43-2.3.5-3.02"></path>
        <path d="M12 10a2 2 0 0 0-2 2c0 1.02-.1 2.51-.26 4"></path>
        <path d="M8.65 22c.21-.66.45-1.32.57-2"></path>
        <path d="M14 13.12c0 2.38 0 6.38-1 8.88"></path>
        <path d="M2 16h.01"></path>
        <path d="M21.8 16c.2-2 .131-5.354 0-6"></path>
        <path d="M9 6.8a6 6 0 0 1 9 5.2c0 .47 0 1.17-.02 2"></path>
    </svg>
    Vân tay
</button>